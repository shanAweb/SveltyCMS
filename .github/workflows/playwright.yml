name: Playwright Tests

on:
  push:
    branches:
      - main
      - next
  pull_request:
    branches:
      - main
      - next

jobs:
  test:
    name: SveltyCMS Playwright Tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        mongodb-version: [latest]
        test-file:
          - tests/playwright/signupfirstuser.spec.ts
          - tests/playwright/user.spec.ts
          - tests/playwright/oauth-signup-firstuser.spec.ts
          - tests/playwright/collection.spec.ts
          - tests/playwright/language.spec.ts
          - tests/playwright/login.spec.ts
          - tests/playwright/permission-change.spec.ts
          - tests/playwright/user-crud.spec.ts

    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies and Playwright browsers
        uses: actions/cache@v3
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/ms-playwright
          key: ${{ runner.OS }}-bun-playwright-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.OS }}-bun-playwright-
        continue-on-error: true

      - name: Start MongoDB v${{ matrix.mongodb-version }}
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: ${{ matrix.mongodb-version }}
          mongodb-username: admin
          mongodb-password: admin
          mongodb-db: SveltyCMS
          mongodb-port: 27017

      - name: Install dependencies
        run: bun install

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps

      - name: Generate config files
        run: bun run installer --yes

      - name: Run local server
        run: bun run build && bun run preview --port 5173 &

      - name: Run Playwright tests
        run: |
          mkdir -p test-results/playwright
          for file in ${{ matrix.test-file }}; do
            bunx playwright test $file --workers 10 --output=test-results/playwright &
          done
          wait
        env:
          DB_TYPE: 'mongodb'
          DB_HOST: 'localhost'
          DB_PORT: '27017'
          DB_NAME: 'SveltyCMS'
          DB_USER: 'admin'
          DB_PASSWORD: 'admin'
          DB_RETRY_DELAY: '1000'
          DB_RETRY_ATTEMPTS: '3'
          DB_POOL_SIZE: '5'
          MULTI_TENANT: 'false'
          SMTP_HOST: ''
          SMTP_PORT: '587'
          SMTP_EMAIL: ''
          SMTP_PASSWORD: ''
          SERVER_PORT: '4173'
          USE_GOOGLE_OAUTH: 'true'
          GOOGLE_CLIENT_ID: 'dummy-google-client-id-for-testing.apps.googleusercontent.com'
          GOOGLE_CLIENT_SECRET: 'GOCSPX-dummy-google-client-secret-for-ci'
          USE_REDIS: 'false'
          REDIS_HOST: ''
          REDIS_PORT: ''
          REDIS_PASSWORD: ''
          SESSION_CLEANUP_INTERVAL: '60000'
          MAX_IN_MEMORY_SESSIONS: '1000'
          DB_VALIDATION_PROBABILITY: '0.1'
          SESSION_EXPIRATION_SECONDS: '86400'
          USE_MAPBOX: 'false'
          MAPBOX_API_TOKEN: ''
          SECRET_MAPBOX_API_TOKEN: ''
          GOOGLE_API_KEY: ''
          TWITCH_TOKEN: ''
          USE_TIKTOK: 'false'
          TIKTOK_TOKEN: ''
          LLM_APIS: '{}'
          ROLES: '["admin", "editor"]'
          PERMISSIONS: '["create", "read", "update", "delete"]'
          JWT_SECRET_KEY: 'a-super-secret-jwt-key-for-github-actions-that-is-long-enough'
          USE_2FA: 'false'
          TWO_FACTOR_AUTH_SECRET: ''
          TWO_FACTOR_AUTH_BACKUP_CODES_COUNT: '10'
          HOST_DEV: 'http://localhost:5173'
          HOST_PROD: 'http://localhost:4173'
          SITE_NAME: 'SveltyCMS Test Site'
          PASSWORD_LENGTH: '8'
          DEFAULT_CONTENT_LANGUAGE: 'en'
          AVAILABLE_CONTENT_LANGUAGES: '["en", "de", "es"]'
          BASE_LOCALE: 'en'
          LOCALES: '["en", "de"]'
          MEDIA_FOLDER: 'ci-media-files'
          MEDIA_OUTPUT_FORMAT_QUALITY: '{"format": "webp", "quality": 75}'
          MEDIASERVER_URL: ''
          IMAGE_SIZES: '{"thumbnail": 150, "card": 600}'
          MAX_FILE_SIZE: '10485760'
          BODY_SIZE_LIMIT: '104857600'
          EXTRACT_DATA_PATH: ''
          USE_ARCHIVE_ON_DELETE: 'true'
          SEASONS: 'false'
          SEASON_REGION: ''
          PKG_VERSION: 'ci-test-version'
          LOG_LEVELS: '["info", "error", "warn"]'
          LOG_RETENTION_DAYS: '7'
          LOG_ROTATION_SIZE: '5242880'
          DEMO: 'true'

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results
          path: test-results/playwright/
          retention-days: 30

  bun-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate config files
        run: bun run installer --yes

      - name: Run local server
        run: bun run build && bun run preview --port 5173 &
      
      - name: Run Bun tests
        run: |
          mkdir -p test-results/bun
          bun test tests/bun/api/api-endpoints.test.ts > test-results/bun/test-results.txt
        env:
          DB_TYPE: 'mongodb'
          DB_HOST: 'localhost'
          DB_PORT: '27017'
          DB_NAME: 'SveltyCMS'
          DB_USER: 'admin'
          DB_PASSWORD: 'admin'
          DB_RETRY_DELAY: '1000'
          DB_RETRY_ATTEMPTS: '3'
          DB_POOL_SIZE: '5'
          MULTI_TENANT: 'false'
          SMTP_HOST: ''
          SMTP_PORT: '587'
          SMTP_EMAIL: ''
          SMTP_PASSWORD: ''
          SERVER_PORT: '4173'
          USE_GOOGLE_OAUTH: 'true'
          GOOGLE_CLIENT_ID: 'dummy-google-client-id-for-testing.apps.googleusercontent.com'
          GOOGLE_CLIENT_SECRET: 'GOCSPX-dummy-google-client-secret-for-ci'
          USE_REDIS: 'false'
          REDIS_HOST: ''
          REDIS_PORT: ''
          REDIS_PASSWORD: ''
          SESSION_CLEANUP_INTERVAL: '60000'
          MAX_IN_MEMORY_SESSIONS: '1000'
          DB_VALIDATION_PROBABILITY: '0.1'
          SESSION_EXPIRATION_SECONDS: '86400'
          USE_MAPBOX: 'false'
          MAPBOX_API_TOKEN: ''
          SECRET_MAPBOX_API_TOKEN: ''
          GOOGLE_API_KEY: ''
          TWITCH_TOKEN: ''
          USE_TIKTOK: 'false'
          TIKTOK_TOKEN: ''
          LLM_APIS: '{}'
          ROLES: '["admin", "editor"]'
          PERMISSIONS: '["create", "read", "update", "delete"]'
          JWT_SECRET_KEY: 'a-super-secret-jwt-key-for-github-actions-that-is-long-enough'
          USE_2FA: 'false'
          TWO_FACTOR_AUTH_SECRET: ''
          TWO_FACTOR_AUTH_BACKUP_CODES_COUNT: '10'
          HOST_DEV: 'http://localhost:5173'
          HOST_PROD: 'http://localhost:4173'
          SITE_NAME: 'SveltyCMS Test Site'
          PASSWORD_LENGTH: '8'
          DEFAULT_CONTENT_LANGUAGE: 'en'
          AVAILABLE_CONTENT_LANGUAGES: '["en", "de", "es"]'
          BASE_LOCALE: 'en'
          LOCALES: '["en", "de"]'
          MEDIA_FOLDER: 'ci-media-files'
          MEDIA_OUTPUT_FORMAT_QUALITY: '{"format": "webp", "quality": 75}'
          MEDIASERVER_URL: ''
          IMAGE_SIZES: '{"thumbnail": 150, "card": 600}'
          MAX_FILE_SIZE: '10485760'
          BODY_SIZE_LIMIT: '104857600'
          EXTRACT_DATA_PATH: ''
          USE_ARCHIVE_ON_DELETE: 'true'
          SEASONS: 'false'
          SEASON_REGION: ''
          PKG_VERSION: 'ci-test-version'
          LOG_LEVELS: '["info", "error", "warn"]'
          LOG_RETENTION_DAYS: '7'
          LOG_ROTATION_SIZE: '5242880'
          DEMO: 'true'

      - name: Upload Bun test results
        uses: actions/upload-artifact@v4
        with:
          name: bun-test-results
          path: test-results/bun/test-results.txt
          retention-days: 30
